---
title: Testing
description: Unit and integration testing setup and examples for the Toy Store Management API.
---

# Testing

We use **Jest** for running tests and **Supertest** for HTTP integration testing against our Express app. Tests cover:

- **Authentication** (login/register)
- **Customer CRUD**
- **Order endpoints** (nested & bare)
- **Analytics/dashboard**
- **Report generation** (PDF stream)

---

## Example: Auth Integration Tests

```ts
// tests/auth.test.ts
import request from "supertest";
import app from "../src/app";
import { db } from "../src/db";
import { Users } from "../src/db/schema";
import { eq } from "drizzle-orm";

describe("Auth routes", () => {
  let adminToken: string;
  let newUserId: string;

  beforeAll(async () => {
    const res = await request(app).post("/api/auth/login").send({
      email: process.env.ADMIN_EMAIL,
      password: process.env.ADMIN_PASSWORD,
    });
    expect(res.status).toBe(200);
    adminToken = res.body.data.token;
  });

  afterAll(async () => {
    if (newUserId) {
      await db.delete(Users).where(eq(Users.id, newUserId)).execute();
    }
  });

  it("registers a new user with valid admin token", async () => {
    const res = await request(app)
      .post("/api/auth/register")
      .set("Authorization", `Bearer ${adminToken}`)
      .send({
        email: "testuser@example.com",
        password: "pass1234",
        username: "testuser",
        role: "manager",
      });
    expect(res.status).toBe(201);
    expect(res.body.data).toHaveProperty("id");
    newUserId = res.body.data.id;
  });

  it("rejects registration without token", async () => {
    const res = await request(app)
      .post("/api/auth/register")
      .send({ email: "foo@bar.com", password: "pw" });
    expect(res.status).toBe(401);
  });

  it("logs in with valid credentials", async () => {
    const res = await request(app).post("/api/auth/login").send({
      email: process.env.ADMIN_EMAIL,
      password: process.env.ADMIN_PASSWORD,
    });
    expect(res.status).toBe(200);
    expect(res.body.data).toHaveProperty("token");
  });
});
```

---

## Customer CRUD Tests

```ts
// tests/customers.test.ts
import request from "supertest";
import app from "../src/app";

describe("Customer routes", () => {
  let token: string;
  let customerId: string;

  beforeAll(async () => {
    const res = await request(app).post("/api/auth/login").send({
      email: process.env.ADMIN_EMAIL,
      password: process.env.ADMIN_PASSWORD,
    });
    token = res.body.data.token;
  });

  it("creates, retrieves, updates, and deletes a customer", async () => {
    // Create
    const createRes = await request(app)
      .post("/api/customers")
      .set("Authorization", `Bearer ${token}`)
      .send({ name: "Alice", email: "alice@test.com", phone: "123" });
    expect(createRes.status).toBe(201);
    customerId = createRes.body.data.id;

    // Retrieve
    const getRes = await request(app)
      .get(`/api/customers/${customerId}`)
      .set("Authorization", `Bearer ${token}`);
    expect(getRes.status).toBe(200);
    expect(getRes.body.data.email).toBe("alice@test.com");

    // Update
    const updateRes = await request(app)
      .put(`/api/customers/${customerId}`)
      .set("Authorization", `Bearer ${token}`)
      .send({ phone: "456" });
    expect(updateRes.status).toBe(200);
    expect(updateRes.body.data.phone).toBe("456");

    // Delete
    const deleteRes = await request(app)
      .delete(`/api/customers/${customerId}`)
      .set("Authorization", `Bearer ${token}`);
    expect(deleteRes.status).toBe(200);
  });
});
```

---

## Orders & Analytics Tests

```ts
// tests/orders.test.ts
import request from "supertest";
import app from "../src/app";

describe("Order routes", () => {
  // similar pattern: login, create customer, place orders, fetch nested and bare endpoints
});

// tests/analytics.test.ts
import request from "supertest";
import app from "../src/app";

describe("Analytics route", () => {
  it("returns dashboard data", async () => {
    const res = await request(app)
      .get("/api/analytics/dashboard")
      .set("Authorization", `Bearer ${token}`);
    expect(res.status).toBe(200);
    expect(res.body.data).toHaveProperty("totalCustomers");
    expect(Array.isArray(res.body.data.ordersByDay)).toBe(true);
  });
});
```

---

## Running Tests

Run all tests:

```bash
npm run test
```

---

By structuring tests to cover authentication, core CRUD, nested routes, analytics, and reports, we ensure confidence in our APIâ€™s behavior and catch regressions early.
